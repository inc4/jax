package mining

import (
	"encoding/hex"
	"github.com/inc4/jax/mining/test"
	"github.com/stretchr/testify/assert"
	"io"
	"net/http"
	"net/http/httptest"
	"strings"
	"testing"
)

func TestTask(t *testing.T) {
	rpcOutputCh := make(chan string, 10)

	ts := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		res, err := io.ReadAll(r.Body)
		if err != nil {
			t.Fatal(err)
		}
		rpcOutputCh <- hex.EncodeToString(res)
		w.Write([]byte("{\"result\": null}"))
	}))
	defer ts.Close()

	url := "http://a:a@" + strings.TrimPrefix(ts.URL, "http://")
	miner, err := NewMiner(url, "mzDGR33maDBujpqjkvxVzY2ssYDcQG51p3", "mxQsksaTJb11i7vSxAUL6VBjoQnhP3bfFz")
	if err != nil {
		t.Fatal(err)
	}

	err = miner.job.ProcessBeaconTemplate(test.GetBeacon())
	if err != nil {
		t.Fatal(err)
	}
	err = miner.job.ProcessShardTemplate(test.GetShard(), 1)
	if err != nil {
		t.Fatal(err)
	}

	btcHeader, _ := hex.DecodeString("00004020b6ef34e5bcb9662ee1645ab64feb6c5ec29f4e5ab2329c010000000000000000d927ccc17e9e89d135988350c6138545a0798d12ae51adb4995dbfe9adcf71d9e1f33461ba6a0418c7a734ac")
	coinbaseTx, _ := hex.DecodeString("01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff3c0369561608ffffffffffffffff2028cd7057e92b29dc6c5fbedb17d6e3e1c1162954f066bd704d606424cf3b47db0d2f503253482f6a61786e65742fffffffff030000000000000000176a152068747470733a2f2f6a61782e6e6574776f726b200046c3230000000001511027000000000000015100000000")

	err = miner.Solution(btcHeader, coinbaseTx)
	if err != nil {
		t.Fatal(err)
	}

	// todo check what inside
	h := <-rpcOutputCh
	assert.Equal(t, "7b226a736f6e727063223a22312e30222c226d6574686f64223a227375626d6974626c6f636b222c2273636f7065223a22636861696e222c2273686172645f6964223a302c22706172616d73223a5b223030303030303230316665616239366437306137643530656662653038353432336334623832633032303865373432636562393537356539653062363162613762373933356661306131623030316331323065383336633763613334376561363431353631343066396635636661383238396161333062366535656465626135393036653931616466353264653765323764653938333662653761366565626363666532323239636565663632626334663737306635316561663566663535623264363564316163653966323932353066306666306631643033303030303030333838383030303333383838303030333234303030303030323061613562343935363832373039333531353663356162303134306561326665666537383938643365636638643563333934373133306234343865623536306161303130623036303030303430323062366566333465356263623936363265653136343561623634666562366335656332396634653561623233323963303130303030303030303030303030303030643932376363633137653965383964313335393838333530633631333835343561303739386431326165353161646234393935646266653961646366373164396531663333343631626136613034313863376137333461633031303030303030303130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030666666666666666633633033363935363136303866666666666666666666666666666666323032386364373035376539326232396463366335666265646231376436653365316331313632393534663036366264373034643630363432346366336234376462306432663530333235333438326636613631373836653635373432666666666666666666303330303030303030303030303030303030313736613135323036383734373437303733336132663266366136313738326536653635373437373666373236623230303034366333323330303030303030303031353131303237303030303030303030303030303135313030303030303030303030313031303030303030303130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030666666666666666631343032616236393030303030653266353033323533343832663661363137383665363537343634326666666666666666663033303030303030303030303030303030303137366131353230363837343734373037333361326632663661363137383265366536353734373736663732366232303030616332336663303630303030303031373661313532303230323032303230323032303230346134313538323032303230323032303230323032303230323030303030303030303030303030303030313937366139313462393533646164306537393238386565613931383038356339623732633363613534383233343933383861633030303030303030225d2c226964223a317d", h)
	h = <-rpcOutputCh
	assert.Equal(t, "7b226a736f6e727063223a22312e30222c226d6574686f64223a227375626d6974626c6f636b222c2273636f7065223a22636861696e222c2273686172645f6964223a312c22706172616d73223a5b22643734663564313136633231393561616232303532363637313765626334303537623838333131616232633765373765363765663839646137633939333333393030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303065396632393235306666666630643165303130303030303030303030303032303166656162393664373061376435306566626530383534323363346238326330323038653734326365623935373565396530623631626137623739333566613061316230303163313230653833366337636133343765613634313536313430663966356366613832383961613330623665356564656261353930366539316164663532646537653237646539383336626537613665656263636665323232396365656636326263346637373066353165616635666635356232643635643161636539663239323530663066663066316430333030303030303338383830303033333838383030303332343030303030303230616135623439353638323730393335313536633561623031343065613266656665373839386433656366386435633339343731333062343438656235363061613031306230363030303034303230623665663334653562636239363632656531363435616236346665623663356563323966346535616232333239633031303030303030303030303030303030306439323763636331376539653839643133353938383335306336313338353435613037393864313261653531616462343939356462666539616463663731643965316633333436316261366130343138633761373334616330313030303030303031303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030306666666666666666336330333639353631363038666666666666666666666666666666663230323863643730353765393262323964633663356662656462313764366533653163313136323935346630363662643730346436303634323463663362343764623064326635303332353334383266366136313738366536353734326666666666666666663033303030303030303030303030303030303137366131353230363837343734373037333361326632663661363137383265366536353734373736663732366232303030343663333233303030303030303030313531313032373030303030303030303030303031353130303030303030303030303130303030303030313030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303066666666666666663134303261623639303030303065326635303332353334383266366136313738366536353734363432666666666666666666303330303030303030303030303030303030313736613135323036383734373437303733336132663266366136313738326536653635373437373666373236623230303061633233666330363030303030303137366131353230323032303230323032303230323034613431353832303230323032303230323032303230323032303030303030303030303030303030303031393736613931346239353364616430653739323838656561393138303835633962373263336361353438323334393338386163303030303030303030316131623030316331323065383336633763613334376561363431353631343066396635636661383238396161333062366535656465626135393036653931616430313031303030303030303130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030666666666666666631353033633336343039353130303065326635303332353334383266366136313738366536353734363432666666666666666666303330303030303030303030303030303030313736613135323036383734373437303733336132663266366136313738326536653635373437373666373236623230383831333030303030303030303030303139373661393134623935336461643065373932383865656139313830383563396237326333636135343832333439333838616330303030303030303030303030303030313937366139313462393533646164306537393238386565613931383038356339623732633363613534383233343933383861633030303030303030225d2c226964223a327d", h)
}
